name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install nightly --profile minimal --component rustfmt
      - run: cargo +nightly fmt --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install stable --profile minimal
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --no-deps

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install stable --profile minimal
      - uses: Swatinem/rust-cache@v2
      - run: cargo build -p wchipper
      - run: cargo test --workspace
      - run: cargo test -p wordchipper --no-default-features --features client,fast-hash
      - run: cargo test -p wordchipper --no-default-features --tests

  cross:
    name: Cross (no_std)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install stable --profile minimal --target wasm32-unknown-unknown,thumbv7m-none-eabi
      - uses: Swatinem/rust-cache@v2
      - run: cargo check -p wordchipper --target wasm32-unknown-unknown --no-default-features
      - run: cargo check -p wordchipper --target thumbv7m-none-eabi --no-default-features

  wasm:
    name: WASM Bindings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install stable --profile minimal --target wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - run: cargo install wasm-pack --locked
      - run: cd bindings/wasm && wasm-pack test --node

  python:
    name: Python Bindings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: rustup toolchain install stable --profile minimal
      - uses: Swatinem/rust-cache@v2
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "bindings/python/pyproject.toml"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Test
        run: |
          cd bindings/python
          uv venv .venv
          source .venv/bin/activate
          uv pip install maturin pytest
          maturin develop
          pytest tests/ -v

  ci:
    name: CI
    if: always()
    needs: [ fmt, clippy, test, cross, wasm, python ]
    runs-on: ubuntu-latest
    steps:
      - run: |
          results=(
            "${{ needs.fmt.result }}"
            "${{ needs.clippy.result }}"
            "${{ needs.test.result }}"
            "${{ needs.cross.result }}"
            "${{ needs.wasm.result }}"
            "${{ needs.python.result }}"
          )
          for r in "${results[@]}"; do
            if [[ "$r" != "success" ]]; then
              echo "Job failed with result: $r"
              exit 1
            fi
          done
